<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Cold Email Auto Responder - Configurez votre répondeur intelligent</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --secondary: #f9fafb;
            --dark: #111827;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --green-500: #10b981;
            --green-600: #059669;
            --red-500: #ef4444;
            --yellow-500: #f59e0b;
            --blue-50: #eff6ff;
            --blue-500: #3b82f6;
            --container-width: 1280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f9fafb;
            color: var(--gray-800);
            line-height: 1.5;
        }

        /* Layout styles */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 230px;
            background-color: white;
            border-right: 1px solid var(--gray-200);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 20;
            transition: transform 0.3s ease;
        }

        .content-wrapper {
            flex: 1;
            margin-left: 230px;
            transition: margin-left 0.3s ease;
        }

        .main-content {
            padding: 24px 32px;
            max-width: var(--container-width);
            margin: 0 auto;
        }

        /* Header styles */
        .header {
            height: 64px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            padding: 0 32px;
            background-color: white;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--gray-700);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 4px;
            margin-right: 16px;
        }

        .header-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
        }

        /* Logo styles */
        .logo-container {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .logo {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .logo-icon {
            font-size: 1.25rem;
        }

        /* Sidebar menu styles */
        .sidebar-section {
            padding: 20px 0;
        }

        .sidebar-section:not(:last-child) {
            border-bottom: 1px solid var(--gray-200);
        }

        .sidebar-heading {
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            padding: 0 20px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu-item {
            position: relative;
        }

        .sidebar-menu-link {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            color: var(--gray-700);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.875rem;
            position: relative;
            transition: all 0.2s;
        }

        .sidebar-menu-link:hover {
            background-color: var(--gray-50);
            color: var(--primary);
        }

        .sidebar-menu-link.active {
            color: var(--primary);
            background-color: var(--blue-50);
            font-weight: 600;
        }

        .sidebar-menu-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: var(--primary);
        }

        .sidebar-menu-icon {
            margin-right: 12px;
            width: 16px;
            text-align: center;
        }

        /* Page content styles */
        .page-header {
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .page-description {
            color: var(--gray-600);
            max-width: 640px;
        }

        /* Card styles */
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title-icon {
            color: var(--primary);
        }

        .card-body {
            padding: 24px;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            font-size: 0.875rem;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            color: var(--gray-800);
            background-color: white;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: 0;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 4px;
        }

        .input-group {
            position: relative;
        }

        .input-group-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-500);
        }

        .input-group .form-control {
            padding-left: 36px;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        /* Toggle switch */
        .toggle-switch {
            display: flex;
            align-items: center;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
            margin-right: 8px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(16px);
        }

        .toggle-label {
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        /* Button styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            font-weight: 500;
            font-size: 0.875rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-icon {
            margin-right: 8px;
        }

        .btn-lg {
            padding: 12px 20px;
            font-size: 1rem;
        }

        /* Notification dialog */
        .notification-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .notification-dialog.active {
            opacity: 1;
            visibility: visible;
        }

        .notification-content {
            background: white;
            border-radius: 8px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .notification-dialog.active .notification-content {
            transform: translateY(0);
        }

        .notification-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #ecfdf5;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: var(--green-500);
            font-size: 24px;
        }

        .notification-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 12px;
            text-align: center;
        }

        .notification-message {
            color: var(--gray-600);
            margin-bottom: 24px;
            text-align: center;
        }

        .notification-actions {
            display: flex;
            justify-content: center;
        }

        /* Loading animation */
        .btn-loading {
            position: relative;
            pointer-events: none;
        }

        .btn-loading .btn-text {
            visibility: hidden;
        }

        .btn-loading:after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Overlay for mobile menu */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 15;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive styles */
        @media (max-width: 991px) {
            .menu-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .content-wrapper {
                margin-left: 0;
            }

            .header {
                padding: 0 16px;
            }

            .header-title {
                margin-left: auto;
                margin-right: auto;
            }

            .logo {
                font-size: 1rem;
            }
        }

        @media (max-width: 767px) {
            .main-content {
                padding: 16px;
            }

            .card-body {
                padding: 16px;
            }

            .notification-content {
                padding: 24px;
                width: 95%;
            }
        }

        @media (max-width: 480px) {
            .header-title {
                display: none;
            }

            .page-title {
                font-size: 1.25rem;
            }

            .btn-lg {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Mobile menu overlay -->
        <div class="overlay" id="overlay"></div>

        <!-- Sidebar navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-envelope-open-text logo-icon"></i>
                    <span>Cold Email Responder</span>
                </div>
            </div>

            <div class="sidebar-section">
                <h3 class="sidebar-heading">Principal</h3>
                <ul class="sidebar-menu">
                    <!-- Tableau de bord supprimé comme demandé -->
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link active">
                            <i class="fas fa-plus-circle sidebar-menu-icon"></i>
                            Nouvel agent
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="https://eliassaoe.github.io/saas_unlimited_lead/agents" class="sidebar-menu-link">
                            <i class="fas fa-robot sidebar-menu-icon"></i>
                            Mes agents
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="#" class="sidebar-menu-link">
                            <i class="fas fa-envelope sidebar-menu-icon"></i>
                            Conversations
                        </a>
                    </li>
                    <li class="sidebar-menu-item">
                        <a href="https://eliassaoe.github.io/saas_unlimited_lead/playground" class="sidebar-menu-link">
                            <i class="fas fa-flask sidebar-menu-icon"></i>
                            Playground
                        </a>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3 class="sidebar-heading">Paramètres</h3>
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a href="https://eliassaoe.github.io/saas_unlimited_lead/account" class="sidebar-menu-link">
                            <i class="fas fa-user sidebar-menu-icon"></i>
                            Compte
                        </a>
                    </li>
                </ul>
            </div>
        </aside>

        <!-- Main content area -->
        <div class="content-wrapper">
            <header class="header">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="header-title">Nouvel agent</div>
                <div class="user-menu">
                    <a href="#" class="btn">
                        <i class="fas fa-question-circle"></i>
                    </a>
                    <div class="user-icon">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            </header>

            <main class="main-content">
                <div class="page-header">
                    <h1 class="page-title">Créer un nouvel agent IA</h1>
                    <p class="page-description">Configurez votre assistant automatique qui répondra aux emails de prospection et planifiera des rendez-vous pour vous.</p>
                </div>

                <form id="agent-setup-form">
                    <!-- API Configuration Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-key card-title-icon"></i>
                                Configuration API
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label" for="api-key">Clé API Instantly</label>
                                <div class="input-group">
                                    <i class="fas fa-lock input-group-icon"></i>
                                    <input type="password" class="form-control" id="api-key" name="api-key" placeholder="inst_api_..." required>
                                </div>
                                <p class="form-hint">Vous pouvez trouver cette clé dans les paramètres de votre compte Instantly</p>
                            </div>
                        </div>
                    </div>

                    <!-- AI Personalization Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-brain card-title-icon"></i>
                                Personnalisation IA
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label" for="ai-prompt">Instructions pour l'IA</label>
                                <textarea class="form-control" id="ai-prompt" name="ai-prompt" placeholder="Décrivez comment votre IA doit répondre. Par exemple: 'Tu es un assistant commercial pour une agence de marketing digital. Réponds de manière amicale et professionnelle. Propose toujours un appel de découverte pour discuter des besoins du prospect...'" required></textarea>
                                <p class="form-hint">Soyez précis sur le ton, le style et les informations que l'IA doit inclure dans ses réponses</p>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar Integration Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-calendar-alt card-title-icon"></i>
                                Prise de rendez-vous
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label" for="calendly-link">Lien Calendly</label>
                                <div class="input-group">
                                    <i class="fas fa-calendar input-group-icon"></i>
                                    <input type="text" class="form-control" id="calendly-link" name="calendly-link" placeholder="https://calendly.com/votre-nom">
                                </div>
                                <p class="form-hint">Laissez vide si vous ne souhaitez pas proposer de prise de rendez-vous</p>
                            </div>

                            <div class="toggle-switch">
                                <label class="switch">
                                    <input type="checkbox" id="include-calendly" name="include-calendly">
                                    <span class="slider"></span>
                                </label>
                                <span class="toggle-label">Inclure automatiquement le lien dans les réponses</span>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: right; margin-top: 24px;">
                        <button type="submit" class="btn btn-primary btn-lg" id="create-agent">
                            <i class="fas fa-robot btn-icon"></i>
                            <span class="btn-text">Activer mon agent IA</span>
                        </button>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <!-- Success Notification Dialog -->
    <div class="notification-dialog" id="success-dialog">
        <div class="notification-content">
            <div class="notification-icon">
                <i class="fas fa-check"></i>
            </div>
            <h3 class="notification-title">Agent IA activé avec succès!</h3>
            <p class="notification-message">Votre assistant IA est maintenant prêt à répondre à vos emails de prospection. Les réponses seront automatiquement envoyées selon vos instructions.</p>
            <div class="notification-actions">
                <button class="btn btn-primary" id="continue-btn">
                    <i class="fas fa-check-circle btn-icon"></i>
                    <span>Continuer</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Toggle mobile menu
        document.getElementById('menu-toggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        });

        document.getElementById('overlay').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });

        // Fonction pour créer le workflow N8N
        async function createWorkflowInN8N(apiKey, aiPrompt, calendlyLink, includeCalendly) {
            const n8nApiUrl = 'https://eliasse-n8n.onrender.com/rest/workflows';
            const n8nApiKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJlM2JkMzU1MC05OGYwLTRjM2ItOWJmNC0wMzM0OGU5MjAzOTYiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzQxNjQwMDUzfQ.rMdXiVwMqbUogaeRdwekFEK-sC9NER9kRfizH4HqXjg';
            
            // Modifier le message système en fonction des entrées de l'utilisateur
            let systemMessage = `Tâche
Tu envoies des emails réponse aux leads qui te contactent.

Context
Nous aidons les centres de formation à attirer plus d'apprenants grâce à des systèmes IA clé en main qui optimisent leurs méthodes d'acquisition. Nos solutions IA permettent d'améliorer significativement leur capacité à attirer et convertirs des prospects en apprenants et obtenir +20 apprenants supplémentaires dès le premier mois.

Instruction
Je te fournis la réponse du lead.
Tu écris un très court mail en HTML sans sujet dans lequel tu réponds au lead.

${aiPrompt}

Si le lead t'a envoyé un message positif, qu'il est intéressé ou qu'il demande plus d'informations, tu vas simplement le remercier rapidement :
"Merci pour votre réponse, je vous propose un audit gratuit"

Ensuite, tu vas lui envoyer le lien pour réserver un rendez-vous sous cette forme :`;

            // Ajouter le lien Calendly si fourni
            if (calendlyLink) {
                systemMessage += `\nLien de réservation : ${calendlyLink}`;
            } else {
                systemMessage += `\nLien de réservation : https://calendly.com/hamoureliasse/session-offerte-sur-les-agents-ia-clone`;
            }

            systemMessage += `

Le lien doit être affiché en brut, sans bouton.
Tu peux également inclure notre site web pour plus d'informations : https://eliassaoe.github.io/site_web/

Fais très attention à la mise en forme de ton e-mail, il doit être agréable à lire. Le code HTML doit être complet avec DOCTYPE et tout le nécessaire, et tu dois vouvoyer dans ta réponse.

Si le lead répond négativement ou semble ne pas être intéressé, fais une courte réponse pour essayer de mieux comprendre ce qui le bloque et lui expliquer que l'audit est gratuit et durant l'audit gratuit on voit ensemble comment mettre en place l'IA dans ses processus d'acquisition pour attirer plus d'apprenants qualifiés.

Si le lead semble avoir un problème pour prendre rendez-vous ou ne trouve pas le créneau qu'il souhaite avec le lien calendly.
Tu dois lui demander de te proposer un créneau horaire. En fonction de sa réponse, réserve directement un rendez-vous dans le calendrier en utilisant l'outil Google Calendar.

Exemples de phrases à inclure :
\t"Merci pour votre réponse."
\t"L'audit gratuit n'engage en rien."
\t"Nous avons mis ce même système en place dans plusieurs centres de formation, et ils ont tous augmenté leur nombre d'apprenants de 30% dès le premier mois."

Notes
Si on te demande notre site web envoie celui ci : https://eliassaoe.github.io/site_web/ . Tu peux aussi l'envoyer pour une personne qui demande plus de détails 
Important : Utilise le fuseau horaire France/Paris pour créer les rendez-vous dans google calendar
\tFais des réponses très courtes et naturelles.
\tRéponds de manière claire et concise, sans trop de détails. L'objectif est d'inciter le lead à réserver un audit.
\tUtilise le prénom du lead et signe avec ton prénom.
\tSi la personne indique dans son email qu'elle est absente, ne lui envoie pas de réponse.
\tRetourne la réponse à l'email du lead sans l'objet et en html et rien d'autre.`;

            // Configurer le workflow avec les paramètres personnalisés
            const workflowData = {
                "name": "AI Email Responder",
                "nodes": [
                    {
                        "parameters": {
                            "promptType": "define",
                            "text": "={{ $json.reply_text }}\nemail du lead : {{ $json.email_lead }}\nL'email que tu utilise : {{ $json.email_team }} (utilise le meme nom)",
                            "options": {
                                "systemMessage": systemMessage
                            }
                        },
                        "type": "@n8n/n8n-nodes-langchain.agent",
                        "typeVersion": 1.7,
                        "position": [
                            20,
                            0
                        ],
                        "id": "721203fe-2072-4fef-8745-293af7586fe8",
                        "name": "AI Agent"
                    },
                    {
                        "parameters": {
                            "method": "POST",
                            "url": `https://api.instantly.ai/api/v1/unibox/emails/reply?api_key=${apiKey}`,
                            "sendBody": true,
                            "bodyParameters": {
                                "parameters": [
                                    {
                                        "name": "reply_to_uuid",
                                        "value": "={{ $json.data[0].id }}"
                                    },
                                    {
                                        "name": "subject",
                                        "value": "={{ $('Edit Fields').item.json.reply_subject }}"
                                    },
                                    {
                                        "name": "from",
                                        "value": "={{ $('Edit Fields').item.json.email_team }}"
                                    },
                                    {
                                        "name": "to",
                                        "value": "={{ $('Webhook').item.json.body.lead_email }}"
                                    },
                                    {
                                        "name": "body",
                                        "value": "={{ $('Code').item.json.html }}"
                                    }
                                ]
                            },
                            "options": {}
                        },
                        "type": "n8n-nodes-base.httpRequest",
                        "typeVersion": 4.2,
                        "position": [
                            940,
                            0
                        ],
                        "id": "313223c7-8583-438f-96f3-69fafbd97f8c",
                        "name": "HTTP Request"
                    },
                    {
                        "parameters": {
                            "url": `https://api.instantly.ai/api/v1/unibox/emails?api_key=${apiKey}`,
                            "sendHeaders": true,
                            "headerParameters": {
                                "parameters": [
                                    {}
                                ]
                            },
                            "sendBody": true,
                            "bodyParameters": {
                                "parameters": [
                                    {}
                                ]
                            },
                            "options": {}
                        },
                        "type": "n8n-nodes-base.httpRequest",
                        "typeVersion": 4.2,
                        "position": [
                            680,
                            0
                        ],
                        "id": "9cf18a47-73b6-41b7-87a0-84d9feb7f474",
                        "name": "HTTP Request2"
                    },
                    {
                        "parameters": {
                            "assignments": {
                                "assignments": [
                                    {
                                        "id": "fa2119fd-dbb3-4b01-ad4f-a31e4601f837",
                                        "name": "email_lead",
                                        "value": "={{ $json.body.email }}",
                                        "type": "string"
                                    },
                                    {
                                        "id": "f3cc8717-158c-480c-bd80-225b4803a157",
                                        "name": "email_team",
                                        "value": "={{ $json.body.email_account }}",
                                        "type": "string"
                                    },
                                    {
                                        "id": "506efbab-6eef-4f1a-ac3d-650d8b6f51d6",
                                        "name": "reply_subject",
                                        "value": "={{ $json.body.reply_subject }}",
                                        "type": "string"
                                    },
                                    {
                                        "id": "dcffb398-40be-48b6-8f57-4b23644742d1",
                                        "name": "reply_text",
                                        "value": "={{ $json.body.reply_text }}",
                                        "type": "string"
                                    }
                                ]
                            },
                            "options": {}
                        },
                        "type": "n8n-nodes-base.set",
                        "typeVersion": 3.4,
                        "position": [
                            -180,
                            0
                        ],
                        "id": "c955ca28-e429-483c-822d-5ea7744df7e4",
                        "name": "Edit Fields"
                    },
                    {
                        "parameters": {
                            "sessionIdType": "customKey",
                            "sessionKey": "={{ $('Webhook').item.json.body.campaign_id }}",
                            "contextWindowLength": 100
                        },
                        "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
                        "typeVersion": 1.3,
                        "position": [
                            120,
                            400
                        ],
                        "id": "ab67abec-c974-4bfa-8c89-cd7cc559d889",
                        "name": "Window Buffer Memory"
                    },
                    {
                        "parameters": {
                            "model": "=anthropic/claude-3.5-sonnet",
                            "options": {}
                        },
                        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
                        "typeVersion": 1.1,
                        "position": [
                            -40,
                            360
                        ],
                        "id": "362e045f-7c88-4319-ba23-8e20dadc9585",
                        "name": "OpenAI Chat Model",
                        "credentials": {
                            "openAiApi": {
                                "id": "JHHfPewLu5ALOxZT",
                                "name": "Deepseek v3 "
                            }
                        }
                    },
                    {
                        "parameters": {
                            "mode": "runOnceForEachItem",
                            "jsCode": "function formaterPourN8n(texte) {\n    // Nettoie le texte des marqueurs HTML et backticks\n    let texteNettoye = texte.trim();\n    \n    // Supprime les marqueurs de début\n    if (texteNettoye.startsWith('```html')) {\n        texteNettoye = texteNettoye.substring('```html'.length);\n    }\n    \n    // Supprime les marqueurs de fin\n    if (texteNettoye.endsWith('```')) {\n        texteNettoye = texteNettoye.substring(0, texteNettoye.length - 3);\n    }\n    \n    // Retourne l'objet avec le HTML nettoyé\n    return {\n        html: texteNettoye.trim()\n    };\n}\n\n// Traitement de l'entrée\nconst texteOriginal = $json.output;\nreturn formaterPourN8n(texteOriginal);"
                        },
                        "type": "n8n-nodes-base.code",
                        "typeVersion": 2,
                        "position": [
                            440,
                            0
                        ],
                        "id": "abd5fdf6-56ba-4bf0-8d64-54c3ebd8bf49",
                        "name": "Code"
                    },
                    {
                        "parameters": {
                            "httpMethod": "POST",
                            "path": "prospection",
                            "options": {}
                        },
                        "type": "n8n-nodes-base.webhook",
                        "typeVersion": 2,
                        "position": [
                            -480,
                            0
                        ],
                        "id": "0edc0be1-8efe-4670-9f97-ec6698201a2c",
                        "name": "Webhook",
                        "webhookId": "1c0cfa34-672d-4836-a4c1-5912619afa87"
                    },
                    {
                        "parameters": {
                            "calendar": {
                                "__rl": true,
                                "value": "hamoureliasse@gmail.com",
                                "mode": "list",
                                "cachedResultName": "hamoureliasse@gmail.com"
                            },
                            "start": "={{ $fromAI('Start_time_of_meeting') }}",
                            "end": "={{ $fromAI('30_after_start_time') }}",
                            "additionalFields": {
                                "attendees": [
                                    "={{ $json.email_lead }}",
                                    "hamoureliasse@gmail.com",
                                    "samyhamour93@gmail.com"
                                ]
                            }
                        },
                        "type": "n8n-nodes-base.googleCalendarTool",
                        "typeVersion": 1.2,
                        "position": [
                            420,
                            420
                        ],
                        "id": "8e0b7c13-62f1-4017-bedd-a7bae2ea913e",
                        "name": "Google Calendar",
                        "credentials": {
                            "googleCalendarOAuth2Api": {
                                "id": "5uKycoyI9xkusVyl",
                                "name": "Google Calendar account 3"
                            }
                        }
                    },
                    {
                        "parameters": {
                            "operation": "getAll",
                            "calendar": {
                                "__rl": true,
                                "value": "hamoureliasse@gmail.com",
                                "mode": "list",
                                "cachedResultName": "hamoureliasse@gmail.com"
                            },
                            "returnAll": true,
                            "options": {
                                "timeMin": "={{ $fromAI('check_available_slot_after_date') }}"
                            }
                        },
                        "type": "n8n-nodes-base.googleCalendarTool",
                        "typeVersion": 1.2,
                        "position": [
                            260,
                            440
                        ],
                        "id": "bcf8f949-ca1b-43cb-abb9-2862dc079912",
                        "name": "Google Calendar1",
                        "credentials": {
                            "googleCalendarOAuth2Api": {
                                "id": "5uKycoyI9xkusVyl",
                                "name": "Google Calendar account 3"
                            }
                        }
                    }
                ],
                "connections": {
                    "AI Agent": {
                        "main": [
                            [
                                {
                                    "node": "Code",
                                    "type": "main",
                                    "index": 0
                                }
                            ]
                        ]
                    },
                    "HTTP Request2": {
                        "main": [
                            [
                                {
                                    "node": "HTTP Request",
                                    "type": "main",
                                    "index": 0
                                }
                            ]
                        ]
                    },
                    "Edit Fields": {
                        "main": [
                            [
                                {
                                    "node": "AI Agent",
                                    "type": "main",
                                    "index": 0
                                }
                            ]
                        ]
                    },
                    "Window Buffer Memory": {
                        "ai_memory": [
                            [
                                {
                                    "node": "AI Agent",
                                    "type": "ai_memory",
                                    "index": 0
                                }
                            ]
                        ]
                    },
                    "OpenAI Chat Model": {
                        "ai_languageModel": [
                            [
                                {
                                    "node": "AI Agent",
                                    "type": "ai_languageModel",
                                    "index": 0
                                }
                            ]
                        ]
                    },
                    "Code": {
                        "main": [
                            [
                                {
                                    "node": "HTTP Request2",
                                    "type": "main",
                                    "index": 0
                                }
                            ]
                        ]
                    },
                    "Webhook": {
                        "main": [
                            [
                                {
                                    "node": "Edit Fields",
                                    "type": "main",
                                    "index": 0
                                }
                            ]
                        ]
                    },
                    "Google Calendar": {
                        "ai_tool": [
                            [
                                {
                                    "node": "AI Agent",
                                    "type": "ai_tool",
                                    "index": 0
                                }
                            ]
                        ]
                    },
                    "Google Calendar1": {
                        "ai_tool": [
                            [
                                {
                                    "node": "AI Agent",
                                    "type": "ai_tool",
                                    "index": 0
                                }
                            ]
                        ]
                    }
                },
                "active": true,
                "settings": {
                    "executionOrder": "v1"
                },
                "meta": {
                    "instanceId": "5b8ee112f8d3686b3bc97d50979f544174c6c5cdc3ce371837d5ec3d22b5c12b"
                },
                "tags": []
            };
            
            try {
                const response = await fetch(n8nApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-N8N-API-KEY': n8nApiKey
                    },
                    body: JSON.stringify(workflowData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Workflow créé avec succès:', result);
                    
                    // Activer le workflow une fois créé
                    if (result.id) {
                        await activateWorkflow(result.id);
                    }
                    
                    return {
                        success: true,
                        workflowId: result.id,
                        webhookUrl: `https://eliasse-n8n.onrender.com/webhook/prospection`
                    };
                } else {
                    const errorText = await response.text();
                    console.error('Erreur lors de la création du workflow:', errorText);
                    return {
                        success: false,
                        error: errorText
                    };
                }
            } catch (error) {
                console.error('Exception lors de la création du workflow:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Fonction pour activer le workflow
        async function activateWorkflow(workflowId) {
            const n8nApiUrl = `https://eliasse-n8n.onrender.com/rest/workflows/${workflowId}/activate`;
            const apiKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJlM2JkMzU1MC05OGYwLTRjM2ItOWJmNC0wMzM0OGU5MjAzOTYiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzQxNjQwMDUzfQ.rMdXiVwMqbUogaeRdwekFEK-sC9NER9kRfizH4HqXjg';
            
            try {
                const response = await fetch(n8nApiUrl, {
                    method: 'POST',
                    headers: {
                        'X-N8N-API-KEY': apiKey
                    }
                });
                
                if (response.ok) {
                    console.log('Workflow activé avec succès');
                    return true;
                } else {
                    console.error('Erreur lors de l\'activation du workflow:', await response.text());
                    return false;
                }
            } catch (error) {
                console.error('Exception lors de l\'activation du workflow:', error);
                return false;
            }
        }

        // Form submission
        document.getElementById('agent-setup-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('create-agent');
            submitBtn.classList.add('btn-loading');
            
            // Récupérer les valeurs du formulaire
            const apiKey = document.getElementById('api-key').value;
            const aiPrompt = document.getElementById('ai-prompt').value;
            const calendlyLink = document.getElementById('calendly-link').value;
            const includeCalendly = document.getElementById('include-calendly').checked;
            
            try {
                // Appeler la fonction pour créer le workflow dans N8N
                const result = await createWorkflowInN8N(apiKey, aiPrompt, calendlyLink, includeCalendly);
                
                submitBtn.classList.remove('btn-loading');
                
                if (result.success) {
                    // Stocker les informations du workflow pour une utilisation ultérieure
                    localStorage.setItem('workflowId', result.workflowId);
                    localStorage.setItem('webhookUrl', result.webhookUrl);
                    
                    // Afficher le message de succès
                    document.getElementById('success-dialog').classList.add('active');
                } else {
                    alert('Erreur lors de la création de l\'agent : ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                submitBtn.classList.remove('btn-loading');
                alert('Erreur : ' + error.message);
            }
        });

        document.getElementById('continue-btn').addEventListener('click', function() {
            document.getElementById('success-dialog').classList.remove('active');
            // Rediriger vers la page "Mes agents" après avoir fermé le message de succès
            window.location.href = 'https://eliassaoe.github.io/saas_unlimited_lead/agents';
        });
    </script>
</body>
</html>
